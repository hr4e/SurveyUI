
{% extends "base.html" %}{% load staticfiles %}
{% block content %}
 
<div ng-app="EditorApp">

  <!-- Django message middleware notification system -->
  {% if messages %}
      {% for message in messages %}
        <div ng-controller="EditorCtrl">
          <!-- #define ERROR 40 -->
          {% if message.level == 40 %}
          <alert type="danger" ng-init="true" ng-show="visible" close="visible=false">{{ message }}</alert>
          {% endif %}

          <!-- #define WARNING 30 -->
          {% if message.level == 30 %}
          <alert ng-init="true" ng-show="visible" close="visible=false">{{ message }}</alert>
          {% endif %}

          <!-- #define SUCCESS 25 -->
          {% if message.level == 25 %}
          <alert type="success" ng-init="true" ng-show="visible" close="visible=false">{{ message }}</alert>
          {% endif %}

          <!-- #define INFO 20 -->
          {% if message.level == 20 %}
          <alert ng-init="true" ng-show="visible" close="visible=false">{{ message }}</alert>
          {% endif %}

          <!-- #define DEBUG 10 -->
          {% if message.level == 10 %}
          <alert type="danger" ng-init="true" ng-show="visible" close="visible=false">{{ message }}</alert>
          {% endif %}
        </div>
      {% endfor %}
  {% endif %}

  <!-- Partials -->

  <div ng-include="'{{ STATIC_URL }}partials/navbar.html'"></div>


  {% if selectedSurvey == ''%}
  <!-- if no survey is selected -->

    <h1>Project {{ defaultProject.shortTag }}</h1>
    <hr>

    <!-- Force user to select survey -->
    <div ng-controller="SelectSurveyCtrl">
      <div ng-init="open()"></div>
    </div>

    <h3>Please select a survey to edit</h3>

    <script type="text/ng-template" id="selectSurveyModal.html">
      <div ng-include="'{{ STATIC_URL }}partials/selectSurveyModalContents.html'"></div>
    </script>

    <script type="text/javascript">
      var SurvSelectCtrl = function($scope) {
        $scope.visible = false;
        $scope.surveys = [];
        {% for survey in listSurveys %}
          $scope.surveys.push({
            name: '{{ survey.questionnaireID.shortTag }}', 
            desc: '{{ survey.questionnaireID.description }}',
          });
        {% endfor %}
        $scope.setSelected = function() {
            $scope.selected = this.survey.name;
        };
        $scope.isSelected = function() {
          if (this.survey.name == $scope.selected)
            return true;
          else {
            return false;
          }
        };

      };
    </script>


  {% else %}
  <!-- if a survey is selected -->

    <!-- Survey editor Page -->
    <h1>Project {{ defaultProject.shortTag }} > {{ selectedSurvey.shortTag }}</h1>
    <h4>{{ selectedSurvey.description }}</h4>
    <hr>

    <!-- API: Add new page btn -->
    <div ng-controller="NewPageModalCtrl">
      <button class="btn btn-primary btn-lg" ng-click="open()">Add a new page</button>
      <div ng-show="selected">Selection from a modal: {{ selected }}</div>
    </div>

    <div ng-controller="SelectPageCtrl">

      <!-- API: select a page bar -->
      <pagination total-items="totalPages" ng-model="selectedPage" max-size="maxSize" class="pagination-sm" boundary-links="true" rotate="false" num-pages="numPages"></pagination>

      <!-- API: add new question btn -->
      <div ng-controller="NewQuestionModalCtrl">
        {% verbatim %}
        <button class="btn btn-primary btn-lg" ng-click="open(listPages[selectedPage-1].currentPage, selectedSurvey)">Add a new question to page {{ selectedPage }}</button>
        {% endverbatim %}
        
      </div>


      {% verbatim %}
      <pre>Page: {{selectedPage}} / {{numPages}}</pre>
      {% endverbatim %}
      <hr />

      <accordion close-others="oneAtATime">
        <accordion-group ng-repeat="listQues in allQuestions" is-open="(selectedPage-1)==$index" ng-click="setSelected()">
        <accordion-heading>
            {% verbatim %}{{ listPages[$index].currentPage }}{% endverbatim %}

        </accordion-heading>

        <!-- Page content: question list start -->
          <div ng-if="listQues">
            <div ng-repeat="ques in listQues">

              <div contenteditable ng-bind-html="ques.questionTag"></div>
              <div contenteditable ng-bind-html="ques.questionText"></div>
              <hr ng-if="!$last">
            </div>
          <br>
          </div>
          <div ng-if="listQues[0]==null">
            <p> No questions </p>
          </div>
        <!-- page content end -->
        </accordion-group>
      </accordion>


    <!-- Django-Angular Script -->

    <script type="text/javascript">
      var SelectPageCtrl = function ($scope, $sce) {
        $scope.maxSize = 5;
        $scope.totalPages = 10 * {{ numPages }};
        $scope.selectedPage = 1;
        $scope.selectedSurvey = '{{ selectedSurvey.shortTag }}';
        
        $scope.status = {
          isFirstOpen: true,
          isFirstDisabled: false
        };
        <!-- API: 2-way data bind the list of pages -->
        $scope.listPages = [];
        {% for page in listPages %}
          $scope.listPages.push({
            currentPage : '{{ page.pageID.shortTag }}',
            nextPage : '{{ page.nextPageID.shortTag }}',
          });
        {% endfor %}

        <!-- API: 2 way data bind the list of list_questions -->
        $scope.allQuestions = [];
        {% for page in allQuestions %}
          $scope.allQuestions.push([]);
          {% for question in page %}
            $scope.allQuestions[{{ forloop.parentloop.counter0 }}].push({
              questionTag : '{{ question.questionID.questionTag }}',
              questionText : '{{ question.questionID.questionText | linebreaksbr}}',
              });
          {% endfor %}
        {% endfor %}


        $scope.oneAtATime = true;

        $scope.setSelected = function() {
          $scope.selectedPage = this.$index + 1;
        };
        $scope.isSelected = function() {
          if (this.$index+1 == $scope.selectedPage)
            return true;
          else {
            return false;
          }
        };
      };
    </script>


    <!-- Modal Scripts -->

    <script type="text/ng-template" id="addPageModal.html">
      <div class="modal-header">
         <h3 class="modal-title">Add a new page</h3>
      </div>
      <div class="modal-body">
        <form action="../newPage/" method="post">{% csrf_token %}
          {% for field in pageForm %}
            <div class="fieldName">{{ field.html_name }}</div>
            <div class="fieldInput">{{ field }}</div>
          {% endfor %}
          <input type="hidden" value="{{ selectedSurvey.shortTag }}" name="selected">
          <input type="submit" value="Submit" />
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" ng-click="ok()">OK</button>
        <button class="btn btn-warning" ng-click="cancel()">Cancel</button>
      </div>
    </script>

    <script type="text/ng-template" id="addQuestionModal.html">
      <div class="modal-header">
         <h3 class="modal-title">Add a new question to {% verbatim %}{{ page }}{% endverbatim %}</h3>
      </div>
      <div class="modal-body">
        <form action="../newQuestion/" method="post">{% csrf_token %}
          {% for field in questionForm %}
            <div class="fieldName">{{ field.html_name }}</div>
            <div class="fieldInput">{{ field }}</div>
          {% endfor %}
          {% verbatim %}
          <input type="hidden" value="{{ page }}" name="page">
          <input type="hidden" value="{{ survey }}" name="selected">
          {% endverbatim %}
          <input type="submit" value="Submit" />
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary" ng-click="ok()">OK</button>
        <button class="btn btn-warning" ng-click="cancel()">Cancel</button>
      </div>
    </script>
  {% endif %}

</div>
  
{% endblock content %}